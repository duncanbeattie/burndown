/* Caliper.js for Backbone apps v0.3.2 (c) 2013 Coherence Inc () */
!function(a){"use strict";"function"==typeof define&&define.amd?define("caliper-core",[],a):a()}(function(){"use strict";var a={VERSION:"0.1.5"},b=window.Caliper||{};if(b.loaded===!0){var c;return a.VERSION===b.VERSION?(c="Already loaded caliper.core  v"+a.VERSION,b.config&&b.config.debug===!0&&("function"==typeof b.warn?b.warn(c):window.console&&"function"==typeof window.console.warn?window.console.warn("[Caliper] "+c):window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] **WARNNING** "+c))):(c="Failed to load caliper.core  v"+a.VERSION+": "+"another version of caliper.core (v"+b.VERSION+") was already loaded","function"==typeof b.error?b.error(c):window.console&&"function"==typeof window.console.error?window.console.error("[Caliper] "+c):window.console&&"function"==typeof window.console.log&&window.console.log("[Caliper] **ERROR** "+c)),b}a.config={apiKey:null,beaconURL:"//b.caliper.io/_.gif",debug:!1};for(var d in b.config)b.config.hasOwnProperty(d)&&(a.config[d]=b.config[d]);if(Date.now||(Date.now=function(){return(new Date).valueOf()}),a.__empty__=function(){},a.log=window.console&&"function"==typeof window.console.log?function(b){a.config.debug===!0&&window.console.log("[Caliper] "+b)}:a.__empty__,a.warn=window.console&&"function"==typeof window.console.warn?function(b){a.config.debug===!0&&window.console.warn("[Caliper] "+b)}:window.console&&"function"==typeof window.console.log?function(b){a.config.debug===!0&&window.console.log("[Caliper] **WARNNING** "+b)}:a.__empty__,a.error=window.console&&"function"==typeof window.console.error?function(a){window.console.error("[Caliper] "+a)}:window.console&&"function"==typeof window.console.log?function(a){window.console.log("[Caliper] **ERROR** "+a)}:a.__empty__,a.slice=function(a){return Array.prototype.slice.call(a)},a.setImmediate="function"==typeof window.setImmediate?function(){return window.setImmediate.apply(window,arguments)}:function(){var b=a.slice(arguments);return b.splice(1,0,0),window.setTimeout.apply(window,b)},a.randomStr=function(a){var b=a.length;return function(c){for(var d=[],e=0;c>e;e++)d.push(a[Math.floor(Math.random()*b)]);return d.join("")}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"),a.__super__=function(){throw new Error("Cannot call Caliper.__super__ outside of a wrapped function")},a.wrap=function(b,c){return function(){var d=a.__super__,e=this,f=a.slice(arguments);try{return a.__super__="function"==typeof b?function(){return this===a?0===arguments.length?b.apply(e,f):b.apply(e,arguments):b.apply(this,arguments)}:a.__empty__,c.apply(this,arguments)}finally{a.__super__=d}}},a.aliasMethodChain=function(a,b,c,d){var e=a[b];if("function"==typeof e){var f="__"+b+"_without_"+c+"__",g="__"+b+"_with_"+c+"__";a[f]=e,a[g]=a[b]=d}return a},a.nameFor=function(a){return a&&a.constructor?a.__name__||a.constructor.__name__:void 0},a.log("Initializing caliper.core v"+a.VERSION+"..."),!a.config.apiKey||!a.config.apiKey.length)return a.error("Failed to load caliper.core: did you forget to set your Caliper API key?"),void 0;a.sessionID=a.randomStr(16),a.log("Generated session ID "+a.sessionID),a.visitorID=function(){var b=function(){for(var a="_cpv=",b=document.cookie.split(";"),c=0;c<b.length;c++){var d=b[c].trim(),e=d.indexOf(a);if(0===e)return d.substring(5,d.length)}return void 0},c=function(a){var b=new Date((new Date).valueOf()+631152e5);return document.cookie="_cpv="+a+"; expires="+b.toGMTString()+"; path=/",a},d=b();return d&&d.length?a.log("Using existing visitor ID "+d):(d=a.randomStr(16),a.log("Generated visitor ID "+d)),c(d)}();var e=0,f=function(a){"string"==typeof a&&(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(encodeURIComponent(a[c]).replace(/[-_~%]/g,function(a){switch(a){case"-":return"~2D";case"_":return"~5F";case"~":return"~7E";case"%":return"~"}}));return b.join("-")},g=function(a){if("string"==typeof a)return f(a);for(var b=[],c=0;c<a.length;c++)b.push(f(a[c]));return b.join("_")},h=function(a){for(var b in a)return!1;return!0};return a.send=function(b,c){if(!a.config.apiKey||!a.config.apiKey.length)return a.error("Attempted to call send without an API key set, payload dropped"),void 0;if(b&&b.length>0||c&&!h(c)){var d={},f=[];for(var i in a.plugins)a.plugins.hasOwnProperty(i)&&f.push(i+"-"+a.plugins[i].VERSION);d.k=a.config.apiKey,d.c=f.join("_"),d.v=encodeURIComponent(a.visitorID),d.s=a.sessionID;var j=[];for(var k in d)d.hasOwnProperty(k)&&j.push(k+"="+d[k]);for(k in c)c.hasOwnProperty(k)&&j.push(k+"="+encodeURIComponent(c[k]));var l=e++,m=a.config.beaconURL+"?"+j.join("&");b&&(m=m+"&p="+g(b)),a.log("Sending request "+l),m.length>2e3&&a.log("Request "+l+": URL is "+m.length+" characters long, this might cause errors in some browsers!");var n=function(){a.log("Completed request "+l)},o=function(){a.log("Failed request "+l+", giving up")},p=function(b,c,d){return function(){a.log("Failed request "+l+", retrying in "+b+" seconds"),window.setTimeout(function(){a.log("Retrying request "+l),d>0?a.dispatchRequest(m,n,p(b*c,c,d-1)):a.dispatchRequest(m,n,o)},1e3*b)}};a.dispatchRequest(m,n,p(30,2,2))}},a.dispatchRequest=function(a,b,c){var d=new Image;"function"==typeof b&&(d.onload=b),"function"==typeof c&&(d.onerror=c),d.src=a},a.plugins={core:a},a.loaded=!0,window.Caliper=a,a.log("Sucessfully loaded caliper.core v"+a.VERSION),a}),function(a){"use strict";"function"==typeof define&&define.amd?define("caliper-backbone",["caliper-core","backbone","underscore","jquery"],a):a(window.Caliper,window.Backbone,window._,window.jQuery||window.Zepto)}(function(a,b,c,d){"use strict";var e={VERSION:"0.3.2"};if(void 0===a||a.loaded!==!0)window.console&&"function"==typeof window.console.error?window.console.error("[Caliper] Failed to load caliper.backbone: caliper.core could not be found"):window.console&&"function"==typeof window.console.log&&window.console.error("[Caliper] **ERROR** Failed to load caliper.backbone: caliper.core could not be found");else if(a.plugins&&a.plugins.Backbone)a.plugins.Backbone.VERSION===e.VERSION?a.warn("Already loaded caliper.backbone v"+e.VERSION):a.error("Failed to load caliper.backbone v"+e.VERSION+": "+"another version of caliper.backbone (v"+a.plugins.Backbone.VERSION+") was already loaded");else if(void 0===b)a.error("Failed to load caliper.backbone: Backbone could not be found");else if(void 0===c)a.error("Failed to load caliper.backbone: Underscore could not be found");else{a.log("Initializing caiper.backbone v"+e.VERSION),void 0===a.config.enableAjaxFilter&&a.config.disableAjaxFilter===!1&&(a.config.enableAjaxFilter=!0),a.config.enableAjaxFilter=a.config.enableAjaxFilter||!1,a.config.minDuration=a.config.minDuration||50;var f=a.wrap(a.aliasMethodChain,function(b,d,e,f){var g=b[d];if("function"!=typeof g)return b;var h=a.wrap(g,f);return h="function"==typeof g.extend?g.extend({constructor:h}):c.extend(h,g),a.__super__(b,d,e,h)});a.aliasMethodChain(a,"aliasMethodChain","underscore",f);var g=function(a,b){this.method=a,this.url=b,this.startTime=Date.now(),this.pending=!0};g.prototype.stop=function(){this.pending&&(this.stopTime=Date.now(),this.pending=!1)},g.prototype.serialize=function(a){return this.pending===!1?(a=a||0,["a",this.method,this.url,this.startTime-a,this.stopTime-this.startTime]):void 0};var h=function(a){this.viewName=a,this.startTime=Date.now(),this.pending=!0};h.prototype.stop=g.prototype.stop,h.prototype.serialize=function(a){return this.pending===!1?(a=a||0,["r",this.viewName,this.startTime-a,this.stopTime-this.startTime]):void 0};var i=[],j=function(){return i[i.length-1]},k=function(a,b,c){this.klass=a,this.method=b,this.pattern=c,this.startTime=Date.now(),this.events=[],this.finalized=!1,i.push(this)};k.prototype.finalize=function(){if(this.finalized!==!0){var c;for(c=1;c<=i.length;c++)i[i.length-c]===this&&i.splice(i.length-c,1);for(c=0;c<this.events.length;c++)if(this.events[c].pending)return;if(this.stopTime=Date.now(),this.finalized=!0,this.duration=this.stopTime-this.startTime,this.duration<(a.config.minDuration||1))return a.log("Dropped: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms. (minDuration is "+a.config.minDuration+"ms)"),void 0;if(a.config.enableAjaxFilter===!0){var d=!1;for(c=0;c<this.events.length;c++)if(this.events[c]instanceof g){d=!0;break}if(!d)return a.log("Dropped: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms. (enableAjaxFilter is true)"),void 0}a.log("Sending: "+this.klass+"."+this.method+" ("+this.pattern+"), took "+this.duration+"ms.");try{this.url=b.history.getFragment()}catch(e){this.url=window.location.hash.length?window.location.hash.substr(1):window.location.pathname}var f={bs:this.startTime,bd:this.duration,bu:this.url};this.klass&&this.klass.length>0&&(f.bc=this.klass),this.method&&this.method.length>0&&(f.bm=this.method),this.pattern&&this.pattern.length>0&&(f.bp=this.pattern);var h=[];for(c=0;c<this.events.length;c++)h.push(this.events[c].serialize(this.startTime));a.send(h,f)}},void 0!==b.Router&&a.aliasMethodChain(b,"Router","instrumentation",function(){var b=a.nameFor(this);return a.aliasMethodChain(this,"route","instrumentation",function(){var c=a.slice(arguments),d=String(c[0]),e=c[1],f=c[2];return"/"!==d[0]&&"!"!==d[0]&&(d="/"+d),"function"==typeof e?(e=void 0,f=e):void 0===f&&(f=this[e]),c[2]=a.wrap(f,function(){var c=j();return c?(c.klass=b,c.method=e,c.pattern=d):c=new k(b,e,d),a.setImmediate(function(){c.finalize()}),a.__super__()}),a.__super__.apply(this,c)}),a.__super__()}),void 0!==b.View&&a.aliasMethodChain(b,"View","instrumentation",function(){var b=a.nameFor(this);a.aliasMethodChain(this,"initialize","instrumentation",function(){var d;if(!b){b="UnnamedView";var e=c.result(this,"el");"string"==typeof e?b=b+"<"+e+">":this.id?b=b+"<#"+c.result(this,"id")+">":this.className&&(b=b+"<."+c.result(this,"className")+">")}j()||(d=new k(b,"initialize"));var f=a.__super__();return d&&a.setImmediate(function(){d.finalize()}),f}),a.aliasMethodChain(this,"render","instrumentation",function(){var c,d=j();d&&(c=new h(b),d.events.push(c));var e=a.__super__();return c&&c.stop(),e});var d=function(c,d){return a.wrap(c,function(){if(!j()){var c=new k(b,d);a.setImmediate(function(){c.finalize()})}return a.__super__()})};return a.aliasMethodChain(this,"delegateEvents","instrumentation",function(){var b,e,f=a.slice(arguments),g=f[0]||c.result(this,"events");for(var h in g)if(g.hasOwnProperty(h)){if(e=g[h],c.isFunction(e)?b="UnnamedAction":(b=e,e=this[e]),!e)continue;g[h]=d(e,b)}return a.__super__(g)}),a.__super__()}),a.aliasMethodChain(d,"ajax","instrumentation",function(){var b=j();if(b){var c=arguments[1]||arguments[0],d=c.type||"GET",e=c.url||arguments[0];"string"==typeof c&&(c={});var f=new g(d,e);return b.events.push(f),c.success=a.wrap(c.success,function(){return j()!==b&&i.push(b),f.stop(),a.__super__()}),c.error=a.wrap(c.error,function(){return j()!==b&&i.push(b),f.stop(),a.__super__()}),c.complete=a.wrap(c.complete,function(){return a.setImmediate(function(){b.finalize()}),a.__super__()}),c.url=e,a.__super__(c)}return a.__super__()}),b.history=b.history||new b.History,a.plugins.Backbone=e,a.log("Sucessfully loaded caliper.backbone v"+e.VERSION)}return b});